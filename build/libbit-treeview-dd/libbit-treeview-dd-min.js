YUI.add("libbit-treeview-dd",function(e,t){var n;n=e.Base.create("dd",e.Base,[],{_callbacks:{},_ddMap:[],initializer:function(){var t=this.get("model");t.on("change",this._destroyDD,this),this.get("dragdrop")&&(e.Do.after(this._afterRender,this,"render",this),this.after("open",function(e){var t=e.node,n=this.getHTMLNode(t);this._handleBind(n)},this),this.on("drop:enter",function(e){e.drop.get("node").one(".libbit-treeview-icon")&&e.drop.get("node").one(".libbit-treeview-icon").addClass("icon-white")}),this.on("drop:exit",function(e){e.drop.get("node").get("parentNode").hasClass("yui3-treeview-selected")||e.drop.get("node").all(".icon-white").removeClass("icon-white")}),this.on("drag:start",this._handleStart,this),this.on("drop:hit",this._handleDrop,this))},destructor:function(){this._destroyDD()},addCallback:function(e,t,n){this._callbacks[e]={callback:t,context:n}},sizeShims:function(){for(var e in this._ddMap)typeof this._ddMap[e].sizeShim=="function"&&this._ddMap[e].sizeShim()},_destroyDD:function(){if(!this.rendered)return;for(var e in this._ddMap)this._ddMap[e].destroy();this._ddMap=[]},_handleBind:function(t){var n=t.one("."+this.classNames.children).all("[data-libbit-type]:not(.libbit-treeview-drag)"),r=this;n.each(function(t){var n=r.getNodeById(t.getData("node-id")).data;r._createDD(t,n);if(n instanceof e.TB.Category){var i=new e.DD.Drop({node:t,groups:r.get("groups"),bubbleTargets:r});t.addClass("libbit-treeview-drop"),t.addClass("libbit-dd-drop"),r._ddMap.push(i)}})},_bindDD:function(){var t=this,n=this.get("tree"),r;if(this._treeNodes.length===0)return;r=this._treeNodes,e.each(r,function(r){var i,s;i=n.getHTMLNode(r).one("div"),s=r.data;if(e.instanceOf(s,e.TB.Category)){var o=new e.DD.Drop({node:i,groups:t.get("groups"),bubbleTargets:t});i.addClass("libbit-treeview-drop"),t._ddMap.push(o)}t._createDD(i,s)});if(this.get("header")){var i=new e.DD.Drop({node:this.get("contentBox").one(".nav-header"),groups:[e.stamp(this)],bubbleTargets:t});i.on("drop:enter",function(e){e.drop.get("node").get("parentNode").get("parentNode").addClass("libbit-treeview-drop-over-global")}),i.on("drop:exit",function(){e.all(".libbit-treeview-drop-over-global").removeClass("libbit-treeview-drop-over-global")}),t._ddMap.push(i)}},_createDD:function(t,n){var r=this.get("groups"),i=this,s;return n instanceof e.TB.Category&&(r=r.concat([e.stamp(this)])),s=(new e.DD.Drag({node:t,data:n,groups:r,bubbleTargets:i})).plug(e.Plugin.DDProxy,{moveOnEnd:!1,borderStyle:"none"}),t.addClass("libbit-treeview-drag"),this._ddMap.push(s),s},_afterRender:function(){var e=this.get("container");this._handleBind(e)},_handleStart:function(t){var n=t.target,r,i,s,o;r=n.get("data"),n.get("dragNode").setContent(n.get("node").get("outerHTML")),n.get("dragNode").all(".icon-white").removeClass("icon-white"),s=n.get("node"),n._prep(),n.detachAll("drag:start"),i=e.Node.create("<div></div>"),n.set("node",i),n.set("target",!0),n._prep(),o=this._createDD(s,r)},_handleDrop:function(t){var n=this.get("model"),r=t.drag.get("data");newCat=this.getNodeById(t.drop.get("node").getData("node-id")).data,callback=!1,self=this,e.all(".libbit-treeview-drop-over-global").removeClass("libbit-treeview-drop-over-global"),t.drop.get("node").get("parentNode").hasClass("yui3-treeview-selected")||t.drop.get("node").all(".icon-white").removeClass("icon-white"),e.Array.each(t.drag.get("groups"),function(e){if(e in self._callbacks){var n=self._callbacks[e];t.drop.set("data",newCat),n.callback.apply(n.context,[t]),callback=!0}});if(callback)return!0;if(r){var i=r instanceof e.TB.Category?"parent":"category",s=r.get(i),o=s?s.id:null,u=newCat?newCat.get("id"):null;o!==u&&(r.set(i,newCat),r.save(function(){n.load(function(){})}))}}},{ATTRS:{dragdrop:{value:!1},groups:{value:["libbit-treeview"]}}}),e.namespace("Libbit.TreeView").DD=n},"1.0.0",{requires:["libbit-dd","libbit-treeview"]});
