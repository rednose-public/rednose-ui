YUI.add("libbit-controlform",function(e,t){var n;n=e.Base.create("controlForm",e.Base,[],{render:function(e){var t=this;e==null?e=this.get("formsModel"):this.set("formsModel",e),e.sort(),e.each(function(e){t.renderForm(e)})},renderForm:function(t){var n=this,r=this.get("formContainer"),i=t.get("controlForm"),s=i.get("fieldGroups"),o=e.Node.create("<fieldset>"),u=e.Node.create("<legend>");u.set("innerHTML",i.get("caption")),u.on("dblclick",function(){n.editLabel(u)}),o.append(u),o.set("name",t.get("id")),e.Array.each(s,function(e){n.addFieldGroup(o,e)});var a=r.getAttribute("class")+"_"+t.get("direction");r.one("."+a)!=null?r.one("."+a).append(o):r.append(o)},addFieldGroup:function(t,n){var r=this,i=e.Node.create("<ol>"),s;typeof n["fieldGroupItems"]=="undefined"?s=n.get("fieldGroupItems"):s=n.fieldGroupItems;var o=(new e.DD.Drag({node:i,group:["fieldGroup"]})).plug(e.Plugin.DDConstrained,{constrain2node:t}).plug(e.Plugin.DDProxy,{moveOnEnd:!1});o.on("drag:start",function(e){e.target.get("dragNode").setHTML("")}),o.on("drag:drag",function(e){r.reOrderFieldGroupDD(e,t,i)}),o.on("drag:end",function(e){r.reOrderFieldGroup(t)}),i.set("id",n.id),i.on(["mouseover","mouseout"],function(e){e.type=="mouseover"?i.addClass("fieldGroupHighlight"):i.removeClass("fieldGroupHighlight")}),e.Array.each(s,function(t){var n=e.Node.create("<label>"),r=e.Node.create("<li>"),s=null;s=e.Node.create("<input />"),n.set("innerHTML",t.field.name),r.append(n),r.append(s),i.append(r)}),t.append(i)},reOrderFieldGroupDD:function(e,t,n){var r=e.currentTarget.mouseXY[1],i=!1;t.all("ol").each(function(e){if(n.get("id")!==e.get("id")){var t=e.getY(),s=t+parseInt(e.getComputedStyle("height"));r>t&&r<s&&(n.insertBefore(n,e),i=!0)}}),i==0&&r>t.getY()+parseInt(t.getComputedStyle("height"))&&t.append(n)},reOrderFieldGroup:function(e){var t=this.get("formsModel");typeof e.get!="undefined"?t.updateFieldGroupOrder(e.get("name")):t.updateFieldGroupOrder(e.getAttribute("name"))},addFieldGroupToModel:function(e,t){var n=this.get("formsModel");n.each(function(r){if(r.get("id")==e){var i=r.get("controlForm").get("fieldGroups");i.push(t),n.updateFieldGroupOrder(e)}})},ddOver:function(t,n){var r=e.one("#"+n.get("id"));t.type=="drop:over"?r.hasClass("ddOver")===!1&&r.addClass("ddOver"):r.removeClass("ddOver")},ddDrop:function(t,n){var r=this,i=e.DD.DDM.activeDrag,s=e.one("#"+n.get("id"));e.TB.FieldGroup||console.exception&&console.exception("Dependancy error Y.TB.Field not found"),e.instanceOf(i.get("data"),e.TB.FieldGroup)?(fieldGroup=i.get("data"),r.addFieldGroup(s,fieldGroup,!0),r.addFieldGroupToModel(s.get("name"),fieldGroup)):console.exception&&console.exception("DD Error: Expected a Y.TB.FieldGroup"),s.removeClass("ddOver")},toJSON:function(){var t=this.get("formsModel");return e.JSON.stringify(t)},editLabel:function(t){var n=this,r=t.get("parentNode").get("name");e.Libbit.Dialog.prompt("Form title","Value",function(e){return n.get("formsModel").each(function(n){if(n.get("id")==r){var i=n.get("controlForm");i.set("caption",e),t.set("text",i.get("caption"))}}),!0},t.get("text"))}},{ATTRS:{formContainer:{value:null},formsModel:{value:null}}}),e.namespace("Libbit").ControlForm=n},"1.0.0",{requires:["dd-proxy","dd-constrain","node","model-list","model","base","libbit-dialog"]});
