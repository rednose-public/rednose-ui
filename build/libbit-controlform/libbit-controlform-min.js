YUI.add("libbit-controlform",function(e,t){var n;n=e.Base.create("form",e.Model,[],{},{ATTRS:{caption:{value:""},fieldGroups:{value:[]}}}),e.namespace("ControlForm").Form=n;var r;r=e.Base.create("formItem",e.Model,[],{},{ATTRS:{template:{value:null},sortOrder:{value:0},direction:{value:"left"},controlForm:{value:null},fieldGroupOrder:{value:[]}}}),e.namespace("ControlForm").FormItem=r;var r=e.ControlForm.FormItem,n=e.ControlForm.Form,i;i=e.Base.create("formItems",e.ModelList,[],{model:r,parse:function(e){return e.map(function(e){return e.controlForm!==null&&(e.controlForm=new n(e.controlForm)),e})},sync:function(t,n,r){var i=this;t==="read"&&e.io(Routing.generate("libbit_docgen_forms_list",n),{method:"GET",on:{success:function(t,s){i.set("templateId",n.templateId),r(null,e.JSON.parse(s.responseText))}}})},comparator:function(e){return e.get("sortOrder")},setPosition:function(e,t,n){this.updateProperty(e,"sortOrder",t),this.updateProperty(e,"direction",n)},updateProperty:function(e,t,n){this.each(function(r){r.get("id")==e&&r.set(t,n)})},isModified:function(){return!0},addForm:function(e){var t=this,n={id:"tmp_"+Math.round((new Date).getTime()/1e3)+Math.round(Math.random())*999999,direction:"left",controlForm:new t.model({caption:e,fieldGroups:[]}),sortOrder:t.size(),template:t.get("templateId")};t.add(n)},deleteForm:function(e){var t=this;this.each(function(n){n.get("id")==e&&t.remove(n)})}},{ATTRS:{templateId:{value:null}}}),e.namespace("ControlForm").FormItems=i;var s;s=e.Base.create("controlForm",e.Base,[],{viewTemplate:'<div class="formContainer">   <div class="formContainer_left">&nbsp;</div>   <div class="formContainer_right">&nbsp;</div>   <div class="formContainer_proxy">       <div class="formContainer_proxy_arrow"></div>   </div></div>',initializer:function(){this.on("contextMenu:editLabel",this.editLabel),this.on("contextMenu:deleteForm",this.deleteForm)},render:function(e){var t=this;this.get("srcNode").setHTML(this.viewTemplate),e==null?e=this.get("formsModel"):this.set("formsModel",e),e.sort(),e.each(function(e){t.renderForm(e)}),this.fire("rendered")},renderForm:function(t){var n=this,r=this.get("srcNode").one("div"),i=t.get("fieldGroupOrder"),s=t.get("controlForm"),o=s.get("fieldGroups"),u=e.Node.create("<fieldset>"),a=e.Node.create("<legend>");a.set("innerHTML",s.get("caption")),a.plug(e.Libbit.ContextMenu,{content:[{label:"Rename",eventName:"editLabel"},{label:"-"},{label:"Remove",eventName:"deleteForm"}],bubbleTarget:n}),u.append(a),u.set("name",t.get("id")),e.Array.each(i,function(t){e.Array.each(o,function(e){t==e["id"]&&n.addFieldGroup(u,e)})});var f=r.getAttribute("class")+"_"+t.get("direction");r.one("."+f).append(u)},addFieldGroup:function(t,n){var r=this,i=e.Node.create("<ol />"),s;typeof n["fieldGroupItems"]=="undefined"?s=n.get("fieldGroupItems"):s=n.fieldGroupItems;var o=(new e.DD.Drag({node:i,group:["fieldGroup"]})).plug(e.Plugin.DDConstrained,{constrain2node:t}).plug(e.Plugin.DDProxy,{moveOnEnd:!1});o.on("drag:start",function(e){e.target.get("dragNode").setHTML("")}),o.on("drag:drag",function(e){r.reOrderFieldGroupDD(e,t,i)}),o.on("drag:end",function(e){r.reOrderFieldGroup(t)}),i.set("id",n.id),i.on(["mouseover","mouseout"],function(e){e.type=="mouseover"?i.addClass("fieldGroupHighlight"):i.removeClass("fieldGroupHighlight")}),e.Array.each(s,function(t){var n=e.Node.create("<label>"),r=e.Node.create("<li>"),s=null;s=e.Node.create("<input />"),n.set("innerHTML",t.field.name),r.append(n),r.append(s),i.append(r)}),t.append(i)},reOrderFieldGroupDD:function(e,t,n){var r=e.currentTarget.mouseXY[1],i=!1;t.all("ol").each(function(e){if(n.get("id")!==e.get("id")){var t=e.getY(),s=t+parseInt(e.getComputedStyle("height"));r>t&&r<s&&(n.insertBefore(n,e),i=!0)}}),i==0&&r>t.getY()+parseInt(t.getComputedStyle("height"))&&t.append(n)},reOrderFieldGroup:function(e){var t=this.get("formsModel"),n=e.get("name"),r=[];e.all("ol").each(function(){r.push(this.get("id"))}),t.updateProperty(n,"fieldGroupOrder",r)},addFieldGroupToModel:function(e,t){var n=this,r=this.get("formsModel");r.each(function(n){if(n.get("id")==e){var r=n.get("controlForm").get("fieldGroups");r.push(t)}})},ddOver:function(t,n){var r=e.one("#"+n.get("id"));t.type=="drop:over"?r.hasClass("ddOver")===!1&&r.addClass("ddOver"):r.removeClass("ddOver")},ddDrop:function(t,n){var r=this,i=e.DD.DDM.activeDrag,s=e.one("#"+n.get("id"));e.TB.FieldGroup||console.exception&&console.exception("Dependancy error Y.TB.Field not found"),e.instanceOf(i.get("data"),e.TB.FieldGroup)?(fieldGroup=i.get("data"),r.addFieldGroup(s,fieldGroup.getAttrs(),!0),r.addFieldGroupToModel(s.get("name"),fieldGroup),r.reOrderFieldGroup(s)):console.exception&&console.exception("DD Error: Expected a Y.TB.FieldGroup"),s.removeClass("ddOver")},toJSON:function(){var t=this.get("formsModel");return e.JSON.stringify(t)},addForm:function(e){var t=this.get("formsModel");t.addForm(e),this.render()},deleteForm:function(t){var n=this,r=this.get("formsModel"),i=t.node.get("parentNode").get("name");e.Libbit.Dialog.confirm("Delete",'Delete the form "'+t.node.get("innerHTML")+'" and all its fieldgroups?',function(){r.deleteForm(i),n.render()})},editLabel:function(t){var n=this,r=t.node,i=r.get("parentNode").get("name");e.Libbit.Dialog.prompt("Form title","Value",function(e){return n.get("formsModel").each(function(t){if(t.get("id")==i){var n=t.get("controlForm");n.set("caption",e),r.set("text",n.get("caption"))}}),!0},r.get("text"))}},{ATTRS:{srcNode:{value:null},formsModel:{value:null},editMode:{value:!1}}}),e.namespace("Libbit").ControlForm=s},"1.0.0",{requires:["dd-proxy","dd-constrain","node","model-list","model","base","libbit-dialog","libbit-contextmenu"]});
