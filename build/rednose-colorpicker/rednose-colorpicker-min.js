YUI.add("rednose-colorpicker",function(e,t){var n="close",r=e.Base.create("colorpicker",e.Widget,[],{template:'<div class="input-append"><input type="text" id="color" value="#FFFFFF" /><button title="Configure table" type="button" class="btn"><i class="icon-adjust"></i></button></div>',_canvas:null,_imageObj:null,_imageData:null,_mouseActive:!1,_picker:null,initializer:function(){var t=this;this._canvas=e.Node.create('<canvas class="rednose-colorpicker-canvas" height="256" width="256"></canvas>').getDOMNode(),this._picker=e.Node.create('<i class="rednose-colorpicker-pointer"><i>'),this._canvas.addEventListener("mousemove",function(e){t._mouseOver(e)}),this._canvas.addEventListener("mousedown",function(){t._mouseActive=!0}),this._picker.getDOMNode().addEventListener("mousedown",function(){t._mouseActive=!0}),this._canvas.addEventListener("mouseup",function(){t._mouseActive=!1}),this._picker.getDOMNode().addEventListener("mouseup",function(){t._mouseActive=!1}),this.after("colorChange",this._handleColorChange,this)},destructor:function(){this._picker.getDOMNode().removeEventListener("mousemove"),this._canvas.removeEventListener("mousemove")},renderUI:function(){var e=this,t=this.get("contentBox"),n=new Image;t.addClass("rednose-colorpicker"),t.append(this.template),t.one("input#color").on(["change","keyup"],this._handleColorInputChanged,this),t.one("input#color").on("blur",this._handleColorChange,this),t.one("button").on("click",this._handleColorClicked,this)},_handleColorChange:function(){var e=this.get("color"),t=this.get("hex").toUpperCase(),n=this.get("contentBox").one("#color");n.set("value",t),n.setStyle("backgroundColor",t),contrast=1-(.299*e.red+.587*e.green+.114*e.blue)/255,contrast<.5?n.setStyle("color","black"):n.setStyle("color","white")},_handleColorClicked:function(t){var r=this,i=this.get("contentBox"),s=t.currentTarget,o=new e.Node.create('<div class="dropdown-menu"></div>');this._renderCanvas(),o.append(this._canvas),o.append(this._picker),o.setStyle("display","block"),o.setStyle("left",i.getX()),o.setStyle("top",s.getY()+parseInt(s.getComputedStyle("height"))),o.on("clickoutside",function(e){e.target!==s&&(o.remove(),r.fire(n))}),e.one("body").append(o)},_handleColorInputChanged:function(e){var t=e.currentTarget.get("value");t.match(/^#([0-9a-f]{6})$/i)&&this.set("hex",t.toUpperCase())},_mouseOver:function(e){if(this._mouseActive===!0){var t=this._canvas.getBoundingClientRect(),n=Math.round(e.clientX-t.left),r=Math.round(e.clientY-t.top);this._setPicker(e.clientX-3,e.clientY-3),this.set("color",this._getColor(n,r))}},_getColor:function(e,t){var n=this._canvas.getContext("2d");imgObj=this._imageObj,this._imageData===null&&(this._imageData=n.getImageData(0,0,imgObj.height,imgObj.width));var r=this._imageData.data,i=r[(imgObj.width*t+e)*4],s=r[(imgObj.width*t+e)*4+1],o=r[(imgObj.width*t+e)*4+2];return{red:i,green:s,blue:o}},_renderCanvas:function(){var t=this,n=this.get("contentBox"),r=e.Node.create('<canvas height="0" width="0" class="buffer" />'),i=this._canvas.getContext("2d"),s=new Image;n.one("canvas.buffer")===null&&n.append(r),n.append(this._canvas);var o=r.getStyle("backgroundImage").replace("url(","").replace(/'/,"").replace(/"/g,"").replace(/[)]/g,"");s.onload=function(){i.drawImage(s,0,0),t._imageObj=s},s.src=o},_setPicker:function(e,t){this._picker.setStyle("display","block"),this._picker.setX(e),this._picker.setY(t)},_setHex:function(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t!==null&&(this.set("color",{red:parseInt(t[1],16),green:parseInt(t[2],16),blue:parseInt(t[3],16)}),this._picker.setStyle("display","none")),null},_getHex:function(){var e=this.get("color");rgb=[e.red.toString(),e.green.toString(),e.blue.toString()];var t="#"+("0"+parseInt(rgb[0],10).toString(16)).slice(-2)+("0"+parseInt(rgb[1],10).toString(16)).slice(-2)+("0"+parseInt(rgb[2],10).toString(16)).slice(-2);return t}},{ATTRS:{color:{value:{green:255,red:255,blue:255}},hex:{value:null,getter:"_getHex",setter:"_setHex"}}});e.namespace("Rednose").Colorpicker=r},"1.5.0-DEV",{requires:["base","event","node","widget"]});
